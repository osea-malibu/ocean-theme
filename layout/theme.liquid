<!DOCTYPE html>
<html class="no-js bg-white text-seaweed-700" lang="{{ request.locale.iso_code }}" style="--sticky-atc-height: 0px;">
  <head>
    {% render 'gpc-integration-script' %}
    {% render 'google-tag-manager' %}
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="theme-color" content="">
    <link rel="canonical" href="{{ canonical_url }}">
    <link rel="preconnect" href="https://cdn.shopify.com" crossorigin>

    {%- if settings.favicon != blank -%}
      <link rel="icon" type="image/png" href="{{ settings.favicon | image_url: width: 32, height: 32 }}">
    {%- endif -%}

    <title>
      {{ page_title }}
      {%- if current_tags %} &ndash; tagged "{{ current_tags | join: ', ' }}"{% endif -%}
      {%- if current_page != 1 %} &ndash; Page {{ current_page }}{% endif -%}
      {%- unless page_title contains shop.name %} &ndash; {{ shop.name }}{% endunless -%}
    </title>

    {% if page_description %}
      <meta name="description" content="{{ page_description | escape }}">
    {% endif %}
    
    {% liquid
      render 'meta-tags'
      render 'prefetch'
      render 'howl'
      render 'amazon-marketing-cloud'
    %}
    
    <script src="{{ 'slider.js' | asset_url }}" defer></script>
    <script src="{{ 'main.min.js' | asset_url }}" type="module"></script>

    {% comment %} {{ content_for_header }} {% endcomment %}
    {% comment %}theme-check-disable ContentForHeaderModification,RemoteAsset{% endcomment %}
    {{ content_for_header | remove: '"https:\/\/static.rechargecdn.com\/assets\/js\/widget.min.js?shop=osea-malibu.myshopify.com",' | replace: 'id="in-context-paypal-metadata"', 'name="paypal-metadata" content="" id="in-context-paypal-metadata"' | replace: 'id="amazon-payments-metadata"', 'name="amazon-metadata" content="" id="amazon-payments-metadata"' }}
    {% comment %}theme-check-enable ContentForHeaderModification,RemoteAsset{% endcomment %}

    {% style %}
      {% render 'font-face' %}
    {% endstyle %}

    {{ 'application.css' | asset_url | stylesheet_tag: preload: true }}

    <script>document.documentElement.className = document.documentElement.className.replace('no-js', 'js');</script>

    {% comment %}theme-check-disable ParserBlockingScript{% endcomment %}
    <script src="{{ 'loop_bundle.js' | asset_url }}"></script>
    <script>
      async function bootstrapCartProductsSection() {
        // this function is responsible for handling drawer part
        window.Loop = {};
        window.Loop.bundleCartAllItems = await getCartItems();
        // console.log(window.Loop.bundleCartAllItems)
        initLoopBundle("LOOP_osea-malibu_bundles_drawer");
      }
      async function getCartItems() {
        const url = `https://${Shopify.cdnHost.split("/cdn")[0]}/cart.json`;
        const res = await fetch(url).then(response => response.json());
        return res?.items ?? [];
      }
    </script>
    {% comment %}theme-check-enable ParserBlockingScript{% endcomment %}

    {% comment %} Start PostPilot SiteMatch {% endcomment %}
    <script type='text/javascript'>
      var script = document.createElement('script');
      script.src = 'https://xp2023-pix.s3.amazonaws.com/px_FshFG.js';
      document.getElementsByTagName('head')[0].appendChild(script);
    </script>
    {% comment %} End PostPilot SiteMatch {% endcomment %}
  </head>

  <body class="antialiased{% if template.name == 'product' %} pdp pdp-{{ product.handle }}{% elsif template.name == 'collection' %} plp plp-{{ collection.handle }}{% endif %}{% if customer %} logged-in{% endif %}">
    {% render 'adswizz' %}
    <a class="sr-only button button-secondary button-sm focus:not-sr-only focus:py-1 focus:px-2 focus:border focus:fixed focus:top-4 focus:left-4 focus:z-100" href="#MainContent">
      {{- "accessibility.skip_to_text" | t -}}
    </a>
    <a class="sr-only button button-secondary button-sm focus:not-sr-only focus:py-1 focus:px-2 focus:border focus:fixed focus:top-4 focus:left-4 focus:z-100" href="/pages/accessibility">
      {{- 'View our accessibility statement' -}}
    </a>

    {%- if settings.cart_type == 'drawer' -%}
      {%- render 'cart-drawer' -%}
    {%- endif -%}

    <div id="HeaderContent" class="sticky top-0 z-40 motion-safe:transition-colors border-b border-transparent duration-300">
      {% section 'announcement-bar' %}
      {% section 'header' %}
    </div>

    <main id="MainContent" class="content-for-layout outline-0 shadow-none" tabindex="-1">
      {%- if request.path contains 'loop_subscriptions/bundle'-%}
        {% render 'loop_loader' %}
      {%- endif -%}
  
      {{ content_for_layout }}
    </main>

    {% section 'footer' %}

    <ul hidden>
      <li id="a11y-refresh-page-message">{{ 'accessibility.refresh_page' | t }}</li>
      <li id="a11y-new-window-message">{{ 'accessibility.link_messages.new_window' | t }}</li>
    </ul>

    <div id="HeaderScrollPixel" class="absolute w-px h-px bg-transparent top-8"></div>
    
    <script>
      window.shopUrl = '{{ shop.url }}';

      {% if customer %}
        window.customerLoggedIn = true;
      {% else %}
        window.customerLoggedIn = false;
      {% endif %}

      window.routes = {
        cart_add_url: '{{ routes.cart_add_url }}',
        cart_change_url: '{{ routes.cart_change_url }}',
        cart_update_url: '{{ routes.cart_update_url }}',
        cart_url: '{{ routes.cart_url }}',
        predictive_search_url: '{{ routes.predictive_search_url }}'
      };

      window.cartStrings = {
        error: `{{ 'sections.cart.cart_error' | t }}`,
        quantityError: `{{ 'sections.cart.cart_quantity_error_html' | t: quantity: '[quantity]' }}`
      }

      window.variantStrings = {
        addToCart: `{{ 'products.product.add_to_cart' | t }}`,
        soldOut: `{{ 'products.product.sold_out' | t }}`,
        unavailable: `{{ 'products.product.unavailable' | t }}`,
      }

      window.accessibilityStrings = {
        shareSuccess: `{{ 'general.share.success_message' | t }}`,
      }

      window.gwpSettings = {
        enabled: {{ settings.enable_gwp }},
        type: '{{ settings.gwp_type }}',
        loyaltyOnly: {{ settings.is_loyalty_gwp }},
        productQualifierEnabled: {{ settings.enable_product_qualifier_gwp }},
        productQualifierId: '{{ settings.gwp_product_qualifier.id }}',
        tiers: [
          {
            id: "tier3",
            product: '{{ settings.gwp_tier3_product.id }}',
            variant: '{{ settings.gwp_tier3_product.selected_or_first_available_variant.id }}',
            threshold: {{ settings.gwp_tier3_threshold | times: 100 }}
          },
          {
            id: "tier2",
            product: '{{ settings.gwp_tier2_product.id }}',
            variant: '{{ settings.gwp_tier2_product.selected_or_first_available_variant.id }}',
            threshold: {{ settings.gwp_tier2_threshold | times: 100 }}
          },
          {
            id: "tier1",
            product: '{{ settings.gwp_tier1_product.id }}',
            variant: '{{ settings.gwp_tier1_product.selected_or_first_available_variant.id }}',
            threshold: {{ settings.gwp_tier1_threshold | times: 100 }}
          }
        ]
      }
    </script>

    {%- if settings.enable_gwp and settings.gwp_type == 'url' -%}
      <gift-with-purchase-url
        data-product-id="{{ all_products[settings.gwp_tier1_product].id }}"
        data-variant-id="{{ all_products[settings.gwp_tier1_product].selected_or_first_available_variant.id }}"
        data-threshold="{{ settings.gwp_tier1_threshold | times: 100 }}"
      ></gift-with-purchase-url>
      {%- if settings.gwp_tier1_threshold > 0 -%}
        {%- render 'gwp-url-modal' -%}
      {%- endif -%}
    {%- endif -%}

    {%- liquid
      if template.name == 'product'
        render 'klaviyo-add-to-cart'
        render 'recently-viewed-add'
      elsif template.name == 'collection'
        render 'cartful-quiz'
        render 'klaviyo-bis-plp'
      endif
      render 'gorgias-chat-widget'
      render 'bazaarvoice'
      render 'data-layer'
      render 'postscript-popup'
      render 'axon-script'
      render 'minty'
    -%}
{% comment %} <script>
  /**
   * PLP: Store "intent" when user clicks Join Waitlist.
   * Add data-bis-plp to the PLP link/button.
   */
  document.addEventListener('click', (e) => {
    const a = e.target.closest('a[data-bis-plp]');
    if (!a) return;

    const url = new URL(a.href, window.location.origin);
    const variant = url.searchParams.get('variant') || '';
    const handle = (url.pathname.split('/products/')[1] || '').split('?')[0];

    const payload = { handle, variant, ts: Date.now() };
    sessionStorage.setItem('bis_intent', JSON.stringify(payload));
    console.log('[BIS INTENT] set', payload);
  }, true);

  /**
   * PDP: Auto-open the new BIS modal ONLY:
   * - if there is recent bis_intent
   * - AND this product/variant has NOT already auto-opened in this session
   */
  (function () {
    const P = '[BIS AUTOOPEN]';

    if (!location.pathname.startsWith('/products/')) return;

    const raw = sessionStorage.getItem('bis_intent');
    console.log(P, 'loaded', location.href, 'intent raw=', raw);
    if (!raw) return;

    let intent;
    try { intent = JSON.parse(raw); } catch { return; }

    // Expire intent quickly (prevents surprise auto-open later)
    const maxAgeMs = 2 * 60 * 1000; // 2 minutes
    if (!intent.ts || Date.now() - intent.ts > maxAgeMs) {
      console.log(P, 'intent expired, clearing');
      sessionStorage.removeItem('bis_intent');
      return;
    }

    // Figure out current product identity
    const params = new URLSearchParams(location.search);
    const currentVariant = params.get('variant') || '';
    const currentHandle = (location.pathname.split('/products/')[1] || '').split('/')[0];

    // Build a stable "product key" for "once per product page per session"
    // Prefer variant if present; otherwise fall back to handle.
    const productKey = currentVariant
      ? `variant:${currentVariant}`
      : `handle:${currentHandle}`;

    // Read/opened map
    const openedRaw = sessionStorage.getItem('bis_opened_map') || '{}';
    let openedMap = {};
    try { openedMap = JSON.parse(openedRaw); } catch { openedMap = {}; }

    // If this product has already been auto-opened this session, do nothing.
    if (openedMap[productKey]) {
      console.log(P, 'already auto-opened this session for', productKey, 'â€” skipping');
      // consume intent so it doesn't keep trying on refresh
      sessionStorage.removeItem('bis_intent');
      return;
    }

    // OPTIONAL: enforce variant match only if URL includes variant
    if (intent.variant && currentVariant && intent.variant !== currentVariant) {
      console.log(P, 'variant mismatch', { intent: intent.variant, current: currentVariant });
      // do NOT consume intent; maybe they landed on a different variant
      return;
    }

    // Consume intent NOW so it won't re-trigger from refresh/back
    sessionStorage.removeItem('bis_intent');

    // Mark this product as opened for this session
    openedMap[productKey] = Date.now();
    sessionStorage.setItem('bis_opened_map', JSON.stringify(openedMap));
    console.log(P, 'marked opened for session:', productKey);

    // Selector for the new BIS button on PDP (from your rendered HTML)
    const SELECTORS = [
      '#klaviyo-bis-button-container button[type="button"]',
      '#klaviyo-bis-button-container [data-a11y-identifier^="bis-button-"] button[type="button"]',
      '[data-a11y-identifier^="bis-button-"] button[type="button"]',
    ];

    function findBtn() {
      for (const sel of SELECTORS) {
        const el = document.querySelector(sel);
        if (el) return { el, sel };
      }
      return { el: null, sel: null };
    }

    function tryClick(reason) {
      const { el, sel } = findBtn();
      console.log(P, 'tryClick', reason, { found: !!el, sel });

      if (!el) return false;

      const disabled = el.disabled || el.getAttribute('aria-disabled') === 'true';
      console.log(P, 'found button', { disabled, text: (el.textContent || '').trim() });

      if (disabled) return false;

      console.log(P, 'CLICKING', sel);
      el.click();
      return true;
    }

    if (tryClick('initial')) return;

    const obs = new MutationObserver(() => {
      if (tryClick('observer')) obs.disconnect();
    });

    obs.observe(document.documentElement, { childList: true, subtree: true });
    setTimeout(() => obs.disconnect(), 10000);
  })();
</script> {% endcomment %}

    {% render 'content_for_footer' %}
  </body>
</html>