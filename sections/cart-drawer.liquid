{% comment %} theme-check-disable TemplateLength {% endcomment %}
<script src="{{ 'cart.js' | asset_url }}" defer="defer"></script>

<cart-drawer class="fixed z-[2147483002] top-0 left-0 w-screen h-full invisible{% if cart == empty %} is-empty{% endif %}">
  <div id="CartDrawer">
    <div class="cart-scrim block fixed inset-0 bg-seaweed-800/50"></div>
    <div class="cart-drawer bg-white fixed right-0 inset-y-0 w-[40rem] max-w-full overflow-hidden flex flex-col"
      role="dialog"
      aria-modal="true"
      aria-label="{{ 'sections.cart.title' | t }}"
      tabindex="-1"
    >
      {%- liquid
        assign cart_ids = cart.items | map: 'product_id'
        assign travel_sizes = '1.7 oz, 1 oz, 0.6 oz, Scented / 1 oz' | split: ', '
        assign small_products = 'dayglow-face-oil, essential-hydrating-oil-1, hyaluronic-sea-serum, advanced-repair-eye-cream, anti-aging-sea-serum, seaglow-resurfacing-scrub' | split: ', '
      -%}
      <h2 class="sr-only">{{ 'sections.cart.title' | t }}: {{ cart.items.size }} items</h2>
      {% comment %} Gift with purchase {% endcomment %}
      {%- if settings.enable_gwp and settings.gwp_type == 'banner' or settings.gwp_type == 'auto' -%}
        {%- liquid
          assign tier1_product = all_products[settings.gwp_tier1_product]
          assign tier2_product = all_products[settings.gwp_tier2_product]
          assign tier3_product = all_products[settings.gwp_tier3_product]

          assign hide_gwp = false
          assign gwp_threshold = settings.gwp_tier1_threshold | times: 100
          assign remaining_amount = gwp_threshold | minus: cart.total_price
          assign remaining_amount_money = remaining_amount | money
          assign countdown_text = settings.gwp_tier1_text | replace: 'remaining_amount', remaining_amount_money | replace: 'gift_product', tier1_product.title | replace: 'Free Gift - '
          assign gwp_button_id = tier1_product.selected_or_first_available_variant.id
          assign gwp_image_src = settings.gwp_tier1_product.featured_media | image_url: width: 128

          if cart_ids contains tier3_product.id
            assign hide_gwp = true
          elsif cart_ids contains tier2_product.id
            if settings.gwp_tier3_product != nil
              assign gwp_threshold = settings.gwp_tier3_threshold | times: 100
              assign remaining_amount = gwp_threshold | minus: cart.total_price
              assign remaining_amount_money = remaining_amount | money
              assign countdown_text = settings.gwp_tier3_text | replace: 'remaining_amount', remaining_amount_money | replace: 'gift_product', tier3_product.title | replace: 'Free Gift - '
              assign gwp_button_id = tier3_product.selected_or_first_available_variant.id
              assign gwp_image_src = settings.gwp_tier3_product.featured_media | image_url: width: 128
            else 
              assign hide_gwp = true
            endif
          elsif cart_ids contains tier1_product.id
            if settings.gwp_tier2_product != nil
              assign gwp_threshold = settings.gwp_tier2_threshold | times: 100
              assign remaining_amount = gwp_threshold | minus: cart.total_price
              assign remaining_amount_money = remaining_amount | money
              assign countdown_text = settings.gwp_tier2_text | replace: 'remaining_amount', remaining_amount_money | replace: 'gift_product', tier2_product.title | replace: 'Free Gift - '
              assign gwp_button_id = tier2_product.selected_or_first_available_variant.id
              assign gwp_image_src = settings.gwp_tier2_product.featured_media | image_url: width: 128
            else
              assign hide_gwp = true
            endif
          endif
        -%}

        {%- unless settings.gwp_tier1_product == nil or hide_gwp -%}
          <gift-with-purchase-banner class="block {% if cart_ids contains tier1_product.id %}bg-neon-green/25{% else %}bg-seafoam-100{% endif %}">
            <figure class="flex items-center max-w-md pl-6 pr-8 xs:pr-6 mx-auto gap-4">
              {% comment %} theme-check-disable RemoteAsset {% endcomment %}
              <img src="{% render 'imgix', src: gwp_image_src %}" alt="Image of your free gift" loading="lazy" width="64" height="82">
              {% comment %} theme-check-enable RemoteAsset {% endcomment %}
              <figcaption>
                {% if cart_ids contains tier1_product.id %}
                  <span class="badge bg-neon-green rounded-full text-xs uppercase tracking-wider px-3 py-px mb-0.5 -ml-0.5">Bonus Offer!</span>
                {% endif %}
                <h3 class="leading-tight">{% if remaining_amount > 0 %}{{ countdown_text }}{% else %}{{ settings.gwp_success_text }}{% endif %}</h3>
                {%- liquid
                  assign show_gwp_atc = false
                  if settings.gwp_type == 'banner'
                    assign show_gwp_atc = true
                  elsif settings.gwp_type == 'auto'
                    unless cart_ids contains gwp_button_id
                      assign show_gwp_atc = true
                    endunless
                  endif
                -%}
                {%- if remaining_amount <= 0 and show_gwp_atc -%}
                  <button class="button button-xs button-secondary mt-1" id="GwpButton" data-id="{{ gwp_button_id }}">Add to cart</button>
                {%- endif -%}
              </figcaption>
            </figure>
          </gift-with-purchase-banner>
        {%- endunless -%}
      {%- endif -%}

      {% comment %} First time customer GWP {% endcomment %}
      {% if settings.enable_firstime_gwp -%}
        {%- unless customer and customer.orders_count > 0 -%}
          <div class="bg-neon-green/25 px-4 2xs:px-6">
            <figure class="flex items-center max-w-md py-1 pl-6 pr-8 xs:pr-6 mx-auto gap-4">
            {%- liquid
              if settings.gwp_firsttime_product.metafields.custom.product_image_transparent != blank
                assign firsttime_gwp_image_src = settings.gwp_firsttime_product.metafields.custom.product_image_transparent | image_url: width: 60
                assign firsttime_gwp_image_src_2x = settings.gwp_firsttime_product.metafields.custom.product_image_transparent | image_url: width: 120
              else
                assign firsttime_gwp_image_src = settings.gwp_firsttime_product.featured_media | image_url: width: 60
                assign firsttime_gwp_image_src_2x = settings.gwp_firsttime_product.featured_media | image_url: width: 120
              endif
            -%}
            {% comment %} theme-check-disable RemoteAsset {% endcomment %}
            <img
              srcset="{% render 'imgix', src: firsttime_gwp_image_src_2x %} 2x, {% render 'imgix', src: firsttime_gwp_image_src %} 1x"
              src="{% render 'imgix', src: firsttime_gwp_image_src_2x %}"
              loading="lazy"
              width="50"
              height="{{ 50 | divided_by: settings.gwp_firsttime_product.featured_media.aspect_ratio | ceil }}"
              alt="{{ settings.gwp_firsttime_product.featured_media.alt }}"
            >
            {% comment %} theme-check-disable RemoteAsset {% endcomment %}
            <figcaption>
              <h3 class="leading-tight font-medium text-sm">{{ settings.gwp_firsttime_product.title | remove: 'Free Gift - ' }}</h3>
              <p class="text-sm leading-tight">Free gift with every first order</p>
            </figcaption>
            </figure>
          </div>
          <script>console.log("thing", {{ customer.orders_count }})</script>
        {%- endunless -%}
      {%- endif -%}

      {% comment %} Shipping countdown {% endcomment %}
      <shipping-countdown data-threshold="{{ settings.shipping_countdown_threshold }}" class="block px-6 pt-4 pb-2 text-center">
        {%- liquid
          assign remaining_amount = settings.shipping_countdown_threshold | times: 100 | minus: cart.total_price
          assign cart_subscription_items = cart.items | map: 'properties' | where: '_is_subscription', 'true'
        -%}
        <h3 class="mb-1">
          {%- if remaining_amount > 0 and cart_subscription_items.size != cart.items.size -%}
            {%- assign formatted_remaining_amount = remaining_amount | money %}
            {{ settings.shipping_countdown_text | replace: 'remaining_amount', formatted_remaining_amount }}
          {%- else -%}
            {{ settings.shipping_countdown_text_success }}
          {%- endif -%}
        </h3>
        <progress max="100" value="0" class="progress-bar block mx-auto max-w-md motion-safe:transition-all">0%</progress>
      </shipping-countdown>

      {% comment %} Close button {% endcomment %}
      <button
        class="cart-close absolute top-0.5 right-0 p-1 sm:p-4"
        type="button"
        onclick="this.closest('cart-drawer').close()"
        aria-label="{{ 'accessibility.close' | t }}"
      >
        {% render 'icon-close', classes: 'w-8 h-8', stroke_width: 1.5, aria_hidden: true %}
      </button>

      {%- if cart == empty -%}
        <div class="cart-empty h-full overflow-hidden flex flex-col items-center justify-center w-60 mx-auto px-1">
          <h2 class="text-lg tracking-wide font-book mb-4">{{ 'sections.cart.empty' | t }}</h2>
          {%- for link in settings.cart_empty_state_links.links -%}
            <a href="{{ link.url }}" class="button button-secondary mb-4 w-full">{{ link.title }}</a>
          {%- endfor -%}
        </div>
      {%- else -%}
        {%- liquid
          for item in cart.items
            assign hide_upsell = false
            assign normalized_variant_title = item.variant.title | replace: 'fl ', ''
            if small_products contains item.product.handle and normalized_variant_title == '0.34 oz'
              assign hide_upsell = true
            elsif travel_sizes contains normalized_variant_title
              assign hide_upsell = true
            endif

            if item.product.metafields.my_fields.save_with_sets != nil and item.selling_plan_allocation == nil and hide_upsell == false
              unless item.variant.title contains 'Fragrance free'
                assign item_with_set = item
                assign item_with_set_line = forloop.index
              endunless
            endif
          endfor

          assign first_set = item_with_set.product.metafields.my_fields.save_with_sets.value | first
          for tag in first_set.tags
            if tag contains 'badge::save'
              assign set_save_amount = tag | replace: 'badge::save', ''
            endif
          endfor
        -%}

        <div class="cart-drawer-body flex-grow overflow-y-auto px-4 2xs:px-6 pb-12 flex flex-col">
          {% comment %} Save with sets upsell {% endcomment %}
          {%- unless settings.enable_sets_upsell == false or item_with_set == nil or first_set == null or first_set.selected_or_first_available_variant.available == false or cart_ids contains first_set.id -%}
            <save-with-sets
              data-item-to-add="{{ first_set.selected_or_first_available_variant.id }}"
              data-item-to-remove="{{ item_with_set_line }}"
            >
              <div class="relative rounded-lg bg-wave-200 mx-auto max-w-md px-4 py-1 flex gap-4 items-center mt-2">
                {%- liquid
                  if first_set.metafields.custom.product_image_transparent != blank
                    assign sws_image_src = first_set.metafields.custom.product_image_transparent | image_url: width: 60
                    assign sws_image_src_2x = first_set.metafields.custom.product_image_transparent | image_url: width: 120
                  else
                    assign sws_image_src = first_set.featured_media | image_url: width: 60
                    assign sws_image_src_2x = first_set.featured_media | image_url: width: 120
                  endif
                -%}
                {% comment %} theme-check-disable RemoteAsset {% endcomment %}
                <img
                  srcset="{% render 'imgix', src: sws_image_src_2x %} 2x, {% render 'imgix', src: sws_image_src %} 1x"
                  src="{% render 'imgix', src: sws_image_src_2x %}"
                  loading="lazy"
                  width="60"
                  height="{{ 60 | divided_by: first_set.featured_media.aspect_ratio | ceil }}"
                  alt="{{ first_set.featured_media.alt }}"
                >
                {% comment %} theme-check-disable RemoteAsset {% endcomment %}
                <div>
                  <h3 class="leading-tight font-medium text-sm">Save{{ set_save_amount }} with {{ first_set.title }}</h3>
                  <p class="text-sm leading-tight">An item in your cart comes in a set!</p>
                  <button class="button button-xs button-secondary">Upgrade to set</button>
                </div>
              </div>
            </save-with-sets>
          {%- endunless -%}

          {% comment %} Cart items {% endcomment %}
          <cart-drawer-items class="block mx-auto max-w-md mb-12{% if cart == empty %} is-empty{% endif %}" data-cart-ids="{{ cart_ids | json }}">
            <form action="{{ routes.cart_url }}" id="CartDrawer-Form" class="grow flex flex-wrap" method="post">
              <div id="CartDrawer-CartItems" class="js-contents flex flex-col grow motion-safe:transition-opacity">
                {%- if cart != empty -%}
                  <div class="grow">
                    <table class="cart-items block w-full cell" role="table">
                      <thead role="rowgroup" class="hidden">
                        <tr role="row">
                          <th id="CartDrawer-ColumnImage" role="columnheader" scope="col">Image</th>
                          <th id="CartDrawer-ColumnName" role="columnheader" scope="col">Product name</th>
                          <th id="CartDrawer-ColumnSize" role="columnheader" scope="col">Size</th>
                          <th id="CartDrawer-ColumnQuantity" role="columnheader" scope="col">Quantity</th>
                          <th id="CartDrawer-ColumnSubscribe" role="columnheader" scope="col">Subscription</th>
                          <th id="CartDrawer-ColumnTotal" role="columnheader" scope="col">Total</th>
                        </tr>
                      </thead>

                      <tbody role="rowgroup" class="LOOP_osea-malibu_bundles_drawer block w-full">
                        {%- for item in cart.items -%}
                          {% comment %}
                            LOOP SUBSCRIPTIONS (https://apps.shopify.com/loop-subscriptions)
                            DO NOT modify this source code because
                            It is automatically generated from LOOP SUBSCRIPTIONS BUNDLE DESIGN
                            If you need to make change, please contact the Loop support team
                            LOOP BUNDLE CODE STARTS
                          {% endcomment %}
                            {% assign isBundleItem = false %}
                            {%- for property in item.properties -%}
                              {% if property.first == '_bundleId' %}
                                {% assign isBundleItem = true %}
                                {% break %}
                              {% endif %}
                            {%- endfor -%}
                            {% if isBundleItem == true %}
                              {% continue %}
                            {% endif %}
                          {% comment %}
                              LOOP BUNDLE CODE ENDS
                          {% endcomment %}
                          {%- liquid
                            assign item_collections_handles = item.product.collections | map: 'handle'
                            if item_collections_handles contains 'exclude-from-site'
                              assign excluded_from_site = true
                            else
                              assign excluded_from_site = false
                            endif
                          -%}
                          <tr
                            id="CartDrawer-Item-{{ item.index | plus: 1 }}"
                            class="cart-item align-top my-6 grid grid-cols-7 grid-rows-auto [grid-template-areas:'image_name_name_name_name_name_price''image_size_size_sub_sub_sub_sub''image_quant_quant_sub_sub_sub_sub'] td:border-collapse td:border-spacing-0 td:border-0"
                            role="row"
                          >
                            <td class="cart-item__media p-0 [grid-area:image]" role="cell" headers="CartDrawer-ColumnImage">
                              {% if item.image %}
                                <div class="flex h-full items-center">
                                  <a {% unless excluded_from_site %}href="{{ item.url }}"{% endunless %}
                                    class="sr-only"
                                    tabindex="-1"
                                    aria-hidden="true"
                                  ></a>
                                  {%- liquid
                                    assign main_image_src = item.image | image_url: width: 60
                                    assign main_image_src_2x = item.image | image_url: width: 120
                                  -%}
                                  {% comment %} theme-check-disable RemoteAsset {% endcomment %}
                                  <img class="cart-item__image max-w-full"
                                    srcset="{% render 'imgix', src: main_image_src_2x %} 2x, {% render 'imgix', src: main_image_src %} 1x"
                                    src="{% render 'imgix', src: main_image_src_2x %}"
                                    alt="{{ item.image.alt | escape }}"
                                    loading="lazy"
                                    width="60"
                                    height="{{ 60 | divided_by: item.image.aspect_ratio | ceil }}"
                                  >
                                  {% comment %} theme-check-enable RemoteAsset {% endcomment %}
                                </div>
                              {% endif %}
                            </td>
                            <td class="cart-item__name p-0 [grid-area:name]" role="cell" headers="CartDrawer-ColumnName">
                              <div class="flex items-center h-full{% if item.product.type == 'Bundle' %} pr-8 pb-1{% endif %}">
                                {%- if settings.show_vendor -%}
                                  <p class="text-xs text-wave-600">{{ item.product.vendor }}</p>
                                {%- endif -%}
                                <a {% unless excluded_from_site %}href="{{ item.url }}"{% endunless %}
                                  class="block leading-none 2xs:w-full {% if item.selling_plan_allocation %}w-52{% else %}w-60{% endif %}">
                                  {{ item.product.title | replace: 'Plant Based Salicylic', 'Salicylic' | replace: 'Eye Serum', 'Serum' | replace: 'Discovery, ', '' | replace: 'AHA Treatment', '' | replace: ' - Sample', '' | replace: 'Free Gift - ', '' | escape }}
                                </a>
                              </div>
                            </td>
                            <td class="cart-item__size p-0 [grid-area:size]{% if item.product.has_only_default_variant or item.properties.size == 0 %} h-0{% endif %}" role="cell" headers="CartDrawer-ColumnSize">
                              {%- if item.product.has_only_default_variant == false or item.properties.size != 0 and excluded_from_site == false -%}
                                <dl class="flex items-center h-full text-sm pb-1 gap-2">
                                  {%- if item.product.has_only_default_variant == false -%}
                                    {%- for option in item.options_with_values -%}
                                      <div class="product-option flex">
                                        <dt class="mr-1{% if item.options_with_values.size > 1 %} sr-only sm:not-sr-only sm:mr-1{% endif %}">{{ option.name | replace: 'Number of Deliveries', 'Deliveries' }}{% unless option.name contains ':' %}:{% endunless %} </dt>
                                        <dd class="whitespace-nowrap">{{ option.value }}{% unless forloop.last %}, {% endunless %}</dd>
                                      </div>
                                    {%- endfor -%}
                                  {%- endif -%}
                                  {%- for property in item.properties -%}
                                    {%- assign property_first_char = property.first | slice: 0 -%}
                                    {%- if property.last != blank and property_first_char != '_' -%}
                                      <div class="product-option flex">
                                        <dt class="mr-1">{{ property.first }}{% unless property.first contains ':' %}:{% endunless %} </dt>
                                        <dd class="whitespace-nowrap">
                                          {%- if property.last contains '/uploads/' -%}
                                            <a href="{{ property.last }}" class="link" target="_blank" aria-describedby="a11y-new-window-message">
                                              {{ property.last | split: '/' | last }}
                                            </a>
                                          {%- else -%}
                                            {{ property.last }}
                                          {%- endif -%}
                                        </dd>
                                      </div>
                                    {%- endif -%}
                                  {%- endfor -%}
                                </dl>
                              {%- endif -%}
                            </td>
                            <td class="cart-item__quantity p-0 [grid-area:quant]" role="cell" headers="CartDrawer-ColumnQuantity">
                              <div class="flex items-center{% if excluded_from_site == false and item.product.has_only_default_variant or item.properties.size == 0 %} sm:mt-[-14px] -mt-2{% endif %}">
                                {%- unless excluded_from_site -%}
                                  <quantity-input class="quantity inline-flex border border-seaweed-400 rounded-md mr-1">
                                    <button class="quantity__button no-js-hidden cursor-pointer flex items-center justify-center shrink-0 w-6 h-6 border -mt-px -mb-px -ml-px box-content border-transparent rounded-l-md hover:bg-seafoam-100 hover:border-seaweed-500 motion-safe:transition-colors" name="minus" type="button">
                                      <span class="sr-only">{{ 'products.product.quantity.decrease' | t: product: item.product.title | escape }}</span>
                                      {% render 'icon-minus', classes: 'h-4 w-4 text-seaweed-700 pointer-events-none', stroke_width: 2, aria_hidden: true %}
                                    </button>
                                    <input class="quantity__input w-8 h-6 border-0 p-1 text-center"
                                      type="number"
                                      name="updates[]"
                                      value="{{ item.quantity }}"
                                      min="0"
                                      aria-label="{{ 'products.product.quantity.input_label' | t: product: item.product.title | escape }}"
                                      id="Drawer-quantity-{{ item.index | plus: 1 }}"
                                      data-index="{{ item.index | plus: 1 }}"
                                    >
                                    <button
                                      class="quantity__button no-js-hidden cursor-pointer flex items-center justify-center shrink-0 w-6 h-6 border -mt-px -mb-px -mr-px box-content border-transparent rounded-r-md hover:bg-seafoam-100 hover:border-seaweed-500 motion-safe:transition-colors disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:border-transparent disabled:hover:bg-transparent"
                                      name="plus"
                                      type="button"
                                      {% if item.selling_plan_allocation and item.quantity > 3 %}disabled{% endif %}
                                    >
                                      <span class="sr-only">{{ 'products.product.quantity.increase' | t: product: item.product.title | escape }}</span>
                                      {% render 'icon-plus', classes: 'h-4 w-4 text-seaweed-700 pointer-events-none', stroke_width: 2, aria_hidden: true %}
                                    </button>
                                  </quantity-input>
                                {%- endunless -%}

                                <cart-remove-button
                                  id="CartDrawer-Remove-{{ item.index | plus: 1 }}"
                                  data-index="{{ item.index | plus: 1 }}"
                                  class="{% if excluded_from_site %}block{% else %}hidden xs:block{% endif %}"
                                >
                                  <button class="block button button-secondary button-sm px-2" aria-label="{{ 'sections.cart.remove_title' | t: title: item.title }}" name="remove" type="button">
                                    {% render 'icon-remove', classes: 'w-4 h-4 pointer-events-none', stroke_width: 2, aria_hidden: true %}
                                  </button>
                                </cart-remove-button>
                              </div>

                              <div id="CartDrawer-LineItemError-{{ item.index | plus: 1 }}" class="absolute text-coral-800 text-sm hidden" role="alert">
                                <small class="cart-item__error-text"></small>
                                {% render 'icon-error-circle', classes: 'icon icon-error w-4 h-4', aria_hidden: true, stroke_width: 2 %}
                              </div>
                            </td>
                            <td class="cart-item__subscribe p-0 [grid-area:sub]" role="cell" headers="CartDrawer-ColumnSubscribe">
                              {%- liquid
                                for variant in item.product.variants
                                  if variant.id == item.id
                                    assign current_variant = variant
                                  endif
                                endfor

                                assign subscription_group = null
                                for group in product.selling_plan_groups
                                  if group.name == 'Subscribe and Save'
                                    assign subscription_group = group
                                  endif
                                endfor

                                assign allocations = current_variant.selling_plan_allocations
                                assign non_subscription_allocation = false
                                if allocations.size == 1 and allocations[0].selling_plan_group_id != subscription_group.id
                                  assign non_subscription_allocation = true
                                endif
                              -%}
                              {%- if current_variant and current_variant.selling_plan_allocations.size > 0 -%}
                                {%- unless non_subscription_allocation -%}
                                  <div class="cart-subscibe flex flex-col items-end h-full">
                                    {%- liquid
                                      assign groups = item.product.selling_plan_groups
                                      assign default_option = groups[0].selling_plans[0].id
                                      if item.product.metafields.custom.subscription_interval != blank
                                        for plan in groups[0].selling_plans
                                          if plan.name contains item.product.metafields.custom.subscription_interval
                                            assign default_option = plan.id
                                          endif
                                        endfor
                                      endif
                                    -%}
                                    <label for="CartSubscribeCheckbox-{{ item.index | plus: 1 }}" class="cursor-pointer flex-1 flex items-center tracking-wide text-sm relative mb-1">
                                      <input
                                        id="CartSubscribeCheckbox-{{ item.index | plus: 1 }}"
                                        type="checkbox"
                                        class="w-4 h-4 box-content mr-1 input"
                                        name="subscribe"
                                        data-index="{{ item.index | plus: 1 }}"
                                        data-default="{{ default_option }}"
                                        {% if item.selling_plan_allocation %}checked{% endif %}
                                      >
                                      <span id="CartSubscribeCheckbox-label" class="whitespace-nowrap">{% if item.selling_plan_allocation != nil %}Subscribed{% else %}Subscribe & Save 10%{% endif %}</span>
                                    </label>
                                    <div class="relative text-seaweed-700 flex-1">
                                      {%- if item.selling_plan_allocation != nil -%}
                                        <label for="CartSubscribeSelect-{{ item.index | plus: 1 }}" class="absolute left-3 top-1/2 -translate-y-1/2 text-sm pointer-events-none">Ship every</label>
                                        <select
                                          id="CartSubscribeSelect-{{ item.index | plus: 1 }}"
                                          class="input input-sm pl-[5rem] box-border"
                                          name="selling_plan"
                                          data-index="{{ item.index | plus: 1 }}"
                                        >
                                          {%- for option in groups[0].selling_plans -%}
                                            <option value="{{ option.id }}" {%- if option.id == item.selling_plan_allocation.selling_plan.id -%}selected{%- endif -%}>
                                              {{- option.name -}}
                                            </option>
                                          {%- endfor -%}
                                        </select>
                                      {%- endif -%}
                                    </div>
                                  </div>
                                {%- endunless -%}
                              {%- endif -%}
                            </td>
                            <td class="cart-item__totals p-0 [grid-area:price]" role="cell" headers="CartDrawer-ColumnTotal">
                              <div class="flex items-center justify-end h-full">
                                <div class="loading-spinner hidden mr-2">{% render 'icon-spinner', classes: 'w-4 h-4 text-wave-800' %}</div>
                                <div class="cart-item__price-wrapper h-full flex items-center justify-end motion-safe:transition-opacity">
                                  {%- if item.selling_plan_allocation != nil -%}
                                    <div class="flex">
                                      <span class="sr-only">{{ 'products.product.price.regular_price' | t }}</span>
                                      <s class="text-wave-600 mr-1 whitespace-nowrap">{{ item.selling_plan_allocation.compare_at_price | times: item.quantity | money_without_trailing_zeros }}</s>
                                      <span class="sr-only">{{ 'products.product.price.sale_price' | t }}</span>
                                      <span class="whitespace-nowrap">{{ item.selling_plan_allocation.per_delivery_price | times: item.quantity | money }}</span>
                                    </div>
                                  {%- elsif item.product.type == 'Bundle' -%}
                                    <div class="flex flex-col items-end">
                                      <div class="flex tracking-tight">
                                        <span class="sr-only">{{ 'products.product.price.regular_price' | t }}</span>
                                        <s class="text-wave-600 mr-1 whitespace-nowrap">{{ item.variant.compare_at_price | times: item.quantity | money_without_trailing_zeros }}</s>
                                        <span class="sr-only">{{ 'products.product.price.sale_price' | t }}</span>
                                        <span class="whitespace-nowrap">{{ item.variant.price | times: item.quantity | money }}</span>
                                      </div>
                                      <span class="bg-seaweed-200 rounded-sm px-1 py-0.5 text-xs font-book tracking-wide whitespace-nowrap">Bundle</span>
                                    </div>
                                  {%- elsif item.original_line_price != item.final_line_price -%}
                                    <div class="flex">
                                      <span class="sr-only">{{ 'products.product.price.regular_price' | t }}</span>
                                      <s class="text-wave-600 mr-1">{{ item.original_line_price | money }}</s>
                                      <span class="sr-only">{{ 'products.product.price.sale_price' | t }}</span>
                                      <span>{{ item.final_line_price | money }}</span>
                                    </div>
                                  {%- elsif item.product.has_only_default_variant != true and item.variant.compare_at_price > item.variant.price -%}
                                    <div class="flex">
                                      <span class="sr-only">{{ 'products.product.price.regular_price' | t }}</span>
                                      <s class="text-wave-600 mr-1 whitespace-nowrap">{{ item.variant.compare_at_price | times: item.quantity | money }}</s>
                                      <span class="sr-only">{{ 'products.product.price.sale_price' | t }}</span>
                                      <span class="whitespace-nowrap">{{ item.variant.price | times: item.quantity | money }}</span>
                                    </div>
                                  {%- else -%}
                                      {%- if item.product.type == 'Sample' -%}
                                        <span class="flex bg-sand-300 rounded-sm px-1.5 py-0.5 text-xs font-book tracking-wide whitespace-nowrap text-seaweed-600">Sample</span>
                                      {%- elsif item.product.type == 'Free Gift' -%}
                                        <span class="flex bg-seafoam-200 rounded-sm px-1 py-0.5 text-xs font-book tracking-wide whitespace-nowrap">Free Gift</span>
                                      {%- else -%}
                                        <span class="flex">{{ item.original_line_price | money }}</span>
                                      {%- endif -%}
                                  {%- endif -%}

                                  {%- if item.variant.available and item.unit_price_measurement -%}
                                    <div class="unit-price">
                                      <span class="sr-only">{{ 'products.product.price.unit_price' | t }}</span>
                                      {{ item.variant.unit_price | money }}
                                      <span aria-hidden="true">/</span>
                                      <span class="sr-only">&nbsp;{{ 'accessibility.unit_price_separator' | t }}&nbsp;</span>
                                      {%- if item.variant.unit_price_measurement.reference_value != 1 -%}
                                        {{- item.variant.unit_price_measurement.reference_value -}}
                                      {%- endif -%}
                                      {{ item.variant.unit_price_measurement.reference_unit }}
                                    </div>
                                  {%- endif -%}
                                </div>
                              </div>
                            </td>
                          </tr>
                        {%- endfor -%}
                      </tbody>
                    </table>
                  </div>
                {%- endif -%}
                <p id="CartDrawer-LiveRegionText" class="sr-only" role="status"></p>
                <p id="CartDrawer-LineItemStatus" class="sr-only" aria-hidden="true" role="status">{{ 'accessibility.loading' | t }}</p>
              </div>
              <div id="CartDrawer-CartErrors" role="alert" class="absolute inset-x-0 top-0 w-full text-center text-coral-800 text-sm"></div>
            </form>
          </cart-drawer-items>

          {%- liquid
            assign gc_in_cart = cart.items | map: 'product' | where: 'type', 'Gift Card'
            if cart.items.size == gc_in_cart.size
              assign only_gc_in_cart = true
            else
              assign only_gc_in_cart = false
            endif
          -%}
          {% comment %} Printed gift note {% endcomment %}
          {%- if settings.enable_printed_gift_note and only_gc_in_cart == false -%}
            <printed-gift-note>
              <div class="max-w-md mx-auto mb-4">
                <input type="checkbox" id="PrintedGiftNote-Enable" class="peer mr-1" />
                <label for="PrintedGiftNote-Enable" class="inline-block leading-4 relative -bottom-0.5 tracking-wide peer-checked:hidden">Add a gift message?</label>
                <label for="PrintedGiftNote-Enable" class="hidden leading-4 relative -bottom-0.5 tracking-wide peer-checked:inline-block">This is a gift!</label>
                <div class="peer-checked:h-28 h-0 transition-height overflow-hidden flex flex-col mt-3 relative">
                  <label for="PrintedGiftNote-Message" class="text-sm font-medium mb-0.5">Your message:</label>
                  <textarea id="PrintedGiftNote-Message" maxlength="410" aria-labelledby="PrintedGiftNote-Message" aria-describedby="PrintedGiftNote-Error" class="input px-3 mb-px"></textarea>
                  <div class="flex justify-between">
                    <small id="PrintedGiftNote-Error" class="text-coral-800 font-book hidden">
                      {% render 'icon-error-circle', classes: 'icon icon-error w-4 h-4 inline mr-0.5 align-text-top', aria_hidden: true, stroke_width: 2 %}
                      <span id="PrintedGiftNote-ErrorText"></span>
                    </small>
                    <small id="PrintedGiftNote-Confirm" class="text-seafoam-800 font-book hidden">
                      {% render 'icon-check-circle', classes: 'text-seafoam-700 icon icon-error w-4 h-4 inline mr-0.5 align-text-top', aria_hidden: true, stroke_width: 2 %}
                      Message saved!
                    </small>
                    <small class="ml-auto">Max characters: 410</small>
                  </div>
                </div>
              </div>
            </printed-gift-note>
          {%- endif -%}

          {% comment %} Product recommendations {% endcomment %}
          {%- liquid
            assign filtered_items = null | sort
            for item in cart.items
              assign item_collections_handles = item.product.collections | map: 'handle'
              unless item_collections_handles contains 'exclude-from-site' or item_collections_handles contains 'exclude-from-recommendations'
                assign item_array = item | sort
                assign filtered_items = filtered_items | concat: item_array
              endunless
            endfor 
          -%}
          <cart-recommendations data-ids="{{ filtered_items | map: 'product_id' | escape }}">
            <div id="CartDrawer-Recommendations"></div>
          </cart-recommendations>

          {% comment %} Free samples {% endcomment %}
          {%- assign samples_in_cart = cart.items | map: 'product' | where: 'type', 'Sample' -%}
          {%- if samples_in_cart.size < 3 and settings.cart_samples_collection.products.size > 0 and only_gc_in_cart == false -%}
            <div class="cart-samples w-full max-w-md mx-auto bg-wave-100 pt-4 pl-4 pb-1 rounded-sm">
              <h3 class="tracking-wide font-medium text-sm mb-1">Select up to 3 free samples</h3>
              <div class="overflow-x-auto pb-3">
                <ul class="grid gap-2" style="grid-template-columns: repeat({{ settings.cart_samples_collection.products.size }}, 20%);">
                  {%- for sample in settings.cart_samples_collection.products limit: 6 -%}
                    {%- if sample.available and sample.price == 0 -%}
                      {%- unless cart_ids contains sample.id -%}
                        {% render 'product-card-mini',
                          card_product: sample,
                          section_id: section.id,
                          hide_price: true,
                          button_class: 'button-secondary',
                          disable_links: true
                        -%}
                      {%- endunless -%}
                    {%- endif -%}
                  {%- endfor -%}
                </ul>
              </div>
            </div>
          {%- endif -%}
        </div>

        <div class="cart-drawer-footer bg-seafoam-200 flex-shrink-0 px-4 2xs:px-6 py-2">
          <div class="max-w-md mx-auto">
            {%- if settings.show_cart_note -%}
              <details id="Details-CartDrawer mb-4">
                <summary>
                  <span class="flex gap-1 items-center">{{ 'sections.cart.note' | t }}{% render 'icon-caret', classes: 'w-4 h-4' %}</span>
                </summary>
                <cart-note class="cart__note field">
                  <label class="sr-only" for="CartDrawer-Note">{{ 'sections.cart.note' | t }}</label>
                  <textarea id="CartDrawer-Note" class="text-area text-area--resize-vertical" name="note" placeholder="{{ 'sections.cart.note' | t }}">{{ cart.note }}</textarea>
                </cart-note>
              </details>
            {%- endif -%}

            <!-- Subtotals-->
            <div>
              <div class="flex justify-between items-center w-full" role="status">
                <h3>{{ 'sections.cart.subtotal' | t }}</h3>
                <p id="CartDrawer-Total" data-total="{{ cart.total_price }}">{{ cart.total_price | money }}</p>
              </div>
              <div>
                {%- if cart.cart_level_discount_applications.size > 0 -%}
                  <ul class="mb-2" role="list" aria-label="{{ 'customer.order.discount' | t }}">
                    {%- for discount in cart.cart_level_discount_applications -%}
                      <li class="flex items-center justify-end gap-2">
                        {%- render 'icon-discount', aria_hidden: true, classes: 'w-3 h-3' -%}
                        {{ discount.title }}
                        (-{{ discount.total_allocated_amount | money }})
                      </li>
                    {%- endfor -%}
                  </ul>
                {%- endif -%}
              </div>
            </div>

            <!-- CTAs -->
            <div class="mb-2">
              <noscript>
                <button type="submit" class="cart__update-button button button-primary w-full mb-2" form="CartDrawer-Form">{{ 'sections.cart.update' | t }}</button>
              </noscript>
              <button
                type="submit"
                id="CartDrawer-Checkout"
                class="cart__checkout-button button button-primary w-full"
                name="checkout"
                form="CartDrawer-Form"
                onclick="beginCheckoutDataLayer()"
                {% if cart == empty %}disabled{% endif %}>{{ 'sections.cart.checkout' | t }}</button>
            </div>
            <small class="block mx-auto text-xs leading-tight text-center max-w-md child:underline tracking-tight 2xs:tracking-normal">
              {%- if settings.cart_disclaimer != blank -%}{{ settings.cart_disclaimer }}{%- endif -%}
            </small>
          </div>
        </div>
      {%- endif -%}
    </div>
  </div>
</cart-drawer>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    function isIE() {
      const ua = window.navigator.userAgent;
      const msie = ua.indexOf('MSIE ');
      const trident = ua.indexOf('Trident/');
      return (msie > 0 || trident > 0);
    }
    if (!isIE()) return;
    const cartSubmitInput = document.createElement('input');
    cartSubmitInput.setAttribute('name', 'checkout');
    cartSubmitInput.setAttribute('type', 'hidden');
    document.querySelector('#cart').appendChild(cartSubmitInput);
    document.querySelector('#checkout').addEventListener('click', function(event) {
      document.querySelector('#cart').submit();
    });
  });
</script>

<script>
  //data layer begin checkout
  function beginCheckoutDataLayer() {
  var cartContents = fetch(window.Shopify.routes.root + 'cart.js')
  .then(response => response.json())
  .then(data => {
    var lineproducts = data.items;
    var contents = [];
    for (var i = 0; i < lineproducts.length; i++) {
      var subscriptionType;
      if (lineproducts[i]['properties']['_is_subscription'] == 'true') {
        subscriptionType = lineproducts[i]['selling_plan_allocation']['selling_plan']['name'];
      }
      else subscriptionType = undefined;

      contents.push({
        'item_name': lineproducts[i]['title'],
        'item_id': lineproducts[i]['product_id'],
        'item_sku': lineproducts[i]['sku'],
        'item_variant': lineproducts[i]['variant_id'],
        'price': lineproducts[i]['price'] / 100,
        'item_brand': lineproducts[i]['vendor'],
        'item_category': lineproducts[i]['product_type'],
        'quantity': lineproducts[i]['quantity'],
        'subscription': lineproducts[i]['properties']['_is_subscription'],
        'subscription_interval': subscriptionType,
      });
    }
    dataLayer.push({ ecommerce: null });
    dataLayer.push({
      'event': 'begin_checkout_additional',
      {% if customer %}
      'user_data': {
        'email' : '{{ customer.email }}',
        'first_name' : '{{ customer.first_name }}',
        'last_name' : '{{ customer.last_name }}',
        'customer_id': '{{ customer.id | remove: "'" }}',
      },
      {% endif %}
      'ecommerce': {
        'cart_quantity': data.item_count,
        'cart_total': data.total_price/100,
        'currency': data.currency,
        'items': contents
      }
    });
  });
}
</script>
{% comment %} theme-check-enable TemplateLength {% endcomment %}
<script defer="defer">
  //window.Loop = {};
  //window.Loop.bundleCartAllItems = {{ cart.items | json }};
  //initLoopBundle("LOOP_osea-malibu_bundles_drawer");
</script>