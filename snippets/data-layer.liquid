<script>
window.addEventListener('load', function(){
    //Global add to cart
    document.querySelectorAll('form[action="/cart/add"]').forEach(item => {
        item.addEventListener('submit', event => {
            setTimeout(() => {
                var cartContents = fetch(window.Shopify.routes.root + 'cart.js')
                .then(response => response.json())
                .then(data => {
                    var lineproducts = data.items;
                    var id = event.srcElement.closest('form').querySelector('input[name="id"]').value;
                    var index = 0;
    
                    for (let i = 0; i < lineproducts.length; i++) {
                        if (lineproducts[i]['id'] == id) {
                            index = i;
                            break ;
                        }      
                    }
                    var subscriptionType;
                        if (lineproducts[index]['properties']['_is_subscription'] == 'true') {
                            subscriptionType = lineproducts[index]['selling_plan_allocation']['selling_plan']['name'];
                        }
                        else subscriptionType = undefined;
                    
                    var contents = [{
                        'item_name': lineproducts[index]['title'],
                        'item_id': lineproducts[index]['product_id'],
                        'item_sku': lineproducts[index]['sku'],
                        'item_variant': lineproducts[index]['variant_id'],
                        'price': lineproducts[index]['price'] / 100,
                        'item_brand': lineproducts[index]['vendor'],
                        'item_category': lineproducts[index]['product_type'],
                        'quantity': lineproducts[index]['quantity'],
                        'subscription': lineproducts[index]['properties']['_is_subscription'],
                        'subscription_interval': subscriptionType,
                    }];
    
                    dataLayer.push({ ecommerce: null });
                    dataLayer.push({
                        'event': 'add_to_cart_global',
                        {%  if customer %}
                        'user_data': {
                            'email' : '{{ customer.email }}',
                            'first_name' : '{{ customer.first_name }}',
                            'last_name' : '{{ customer.last_name }}',
                            'customer_id': '{{ customer.id | remove: "'" }}',
                        },
                        {%  endif %}
                        'ecommerce': {
                            'currency': data.currency,
                            'items': contents
                        }
                    });
                });
            }, "500")
        });
    });


//begin checkout
  setTimeout(function() {
        var checkoutBtns = [];
        var btnCheckout = document.querySelector('[name="checkout"]');
        var btnShopPay = document.querySelector('[data-testid="ShopifyPay-button"]');
        var btnGooglePay = document.querySelector('[data-testid="GooglePay-button"]');
        var btnApplePay = document.querySelector('[data-testid="ApplePay-button"]');

        if (btnCheckout) {
            checkoutBtns.push( btnCheckout );
        }
        if (btnShopPay) {
            checkoutBtns.push( btnShopPay );
        }
        if (btnGooglePay) {
            checkoutBtns.push( btnGooglePay );
        }
        if (btnApplePay) {
            checkoutBtns.push( btnApplePay );
        }

        checkoutBtns.forEach(function(element) {
            element.addEventListener('click', function(){
                var cartContents = fetch(window.Shopify.routes.root + 'cart.js')
                .then(response => response.json())
                .then(data => {
                    var lineproducts = data.items;
                    var contents = [];
                    for (var i = 0; i < lineproducts.length; i++) {
                        var subscriptionType;
                        if (lineproducts[i]['properties']['_is_subscription'] == 'true') {
                            subscriptionType = lineproducts[i]['selling_plan_allocation']['selling_plan']['name'];
                        }
                        else subscriptionType = undefined;
            
                        contents.push({
                            'item_name': lineproducts[i]['title'],
                            'item_id': lineproducts[i]['product_id'],
                            'item_sku': lineproducts[i]['sku'],
                            'item_variant': lineproducts[i]['variant_id'],
                            'price': lineproducts[i]['price'] / 100,
                            'item_brand': lineproducts[i]['vendor'],
                            'item_category': lineproducts[i]['product_type'],
                            'quantity': lineproducts[i]['quantity'],
                            'subscription': lineproducts[i]['properties']['_is_subscription'],
                            'subscription_interval': subscriptionType,
                        });
                    }
                    dataLayer.push({ ecommerce: null });
                    dataLayer.push({
                        'event': 'begin_checkout_additional',
                        {%  if customer %}
                        'user_data': {
                            'email' : '{{ customer.email }}',
                            'first_name' : '{{ customer.first_name }}',
                            'last_name' : '{{ customer.last_name }}',
                            'customer_id': '{{ customer.id | remove: "'" }}',
                        },
                        {%  endif %}
                        'ecommerce': {
                            'cart_quantity': data.item_count,
                            'cart_total': data.total_price/100,
                            'currency': data.currency,
                            'items': contents
                        }
                    });
                });
            });
        });
    }, 500);
});
</script>