{% comment %}
This is the product image slider snippet.
It is used to display the product images in the product page.
  
Accepts:
  - section: The section object
  - product: The product object
  - classes: Additional CSS classes for the slider (optional). Default is empty.

  Usage:
  {% render 'image-slider',
    section: section,
    product: product,
    classes: 'overflow-hidden gap-0 mb-6 max-w-full glide type-carousel sm:perView-1 md:perView-2 perView-1 lg:flex lg:flex-row-reverse lg:gap-2'
   %}
{% endcomment %}

<glide-slider
  class="overflow-hidden gap-0 max-w-full glide type-carousel perView-1 lg:flex lg:flex-row-reverse lg:gap-2"
  id="Product-Slider"
  data-breakpoint-limit="none"
  data-sr-active-slide-only="true"
>
  {% render 'product-text-badge', product: product, classes: 'z-10 right-2 top-2 bg-p-surface text-p-inverse-d3 lg:text-base' %}

  <div class="glide__track md:rounded-xl" data-glide-el="track">
    <ul class="min-h-full glide__slides">

      {%- liquid
        assign gallery_limit = section.settings.gallery_limit

        if product.metafields.custom.pdp_main_image != blank
          assign slider_images = product.metafields.custom.pdp_main_image.value | concat: product.media
          assign variant_image_index = 1
          assign badge_count = 2
        else
          assign slider_images = product.media
          assign variant_image_index = 0
          assign badge_count = 1
        endif
      -%}

      {%- for media in slider_images limit: gallery_limit -%}
        <li class="glide__slide relative" data-media-id="{{ section.id }}-{{ media.id }}" {% unless forloop.first %}aria-hidden="true"{% endunless %}>

          {%- if media.media_type == 'image' -%}

            {%- if forloop.index <= badge_count -%}
              {% render 'product-image-badge', product: product, classes: 'z-10 left-2 top-2 w-16 xl:w-20 2xl:w-24 gap-2' %}
            {%- endif -%}

            {%- liquid
              assign main_master = media | image_url
              assign main_w_small = 480
              assign main_w_large = 960

              # safe aspect guard
              if media.aspect_ratio and media.aspect_ratio > 0
                assign aspect = media.aspect_ratio
              else
                assign aspect = 1
              endif

              # choose a width attr fallback
              if media.width and media.width > 0
                assign display_width = media.width
              else
                assign display_width = main_w_small
              endif

              assign display_height = display_width | divided_by: aspect | round
            -%}

            {% comment %} theme-check-disable RemoteAsset {% endcomment %}
            <img
              {% if product.selected_or_first_available_variant.featured_media != null and forloop.index0 == variant_image_index %}
                id="Product-VariantImage"
              {% endif %}

              srcset="
                {% render 'imgix', src: main_master, w: 360 %} 360w,
                {% render 'imgix', src: main_master, w: 420 %} 420w,
                {% render 'imgix', src: main_master, w: 560 %} 560w,
                {% render 'imgix', src: main_master, w: 720 %} 720w,
                {% render 'imgix', src: main_master, w: 840 %} 840w,
                {% render 'imgix', src: main_master, w: 960 %} 960w,
                {% render 'imgix', src: main_master, w: 1200 %} 1200w,
                {% render 'imgix', src: main_master, w: 1600 %} 1600w
              "
              src="{% render 'imgix', src: main_master, w: 720 %}"

              loading="{% if forloop.first %}eager{% else %}lazy{% endif %}"
              {% if forloop.first %}fetchpriority="high"{% endif %}
              decoding="async"

              alt="{{ media.alt | escape }}"

              width="{{ display_width }}"
              height="{{ display_height }}"

              sizes="(min-width: 1280px) 58vw, (min-width: 1024px) 60vw, (min-width: 768px) 50vw, 100vw"
              class="object-cover min-h-full"
            >
            {% comment %} theme-check-enable RemoteAsset {% endcomment %}

          {%- elsif media.media_type == 'video' -%}

            <deferred-media class="relative w-full h-full deferred-media no-js-hidden" data-media-id="{{ section.id }}">
              {% render 'video-poster-button', section_id: section.id, media: media, classes: 'absolute w-full h-full deferred-media__poster' %}

              <template>

                {%- liquid
                  assign poster_master = media.preview_image | image_url
                  # safe aspect ratio & dims for poster
                  if media.preview_image.width and media.preview_image.width > 0
                    assign poster_w_attr = media.preview_image.width
                  else
                    assign poster_w_attr = 800
                  endif

                  if media.preview_image.aspect_ratio and media.preview_image.aspect_ratio > 0
                    assign posteraspect = media.preview_image.aspect_ratio
                  else
                    assign posteraspect = 1
                  endif

                  assign poster_h_attr = poster_w_attr | divided_by: posteraspect | round
                -%}

                {% comment %}theme-check-disable RemoteAsset {% endcomment %}
                <video
                  class="object-cover w-full h-full md:rounded-md"
                  playsinline autoplay muted loop controls
                  poster="{% render 'imgix', src: poster_master, w: 800 %}"
                >
                  {%- for source in media.sources -%}
                    <source src="{{ source.url }}" type="video/{{ source.format }}">
                  {%- endfor -%}
                </video>
                {% comment %}theme-check-enable RemoteAsset {% endcomment %}
              </template>
            </deferred-media>

          {%- endif -%}

        </li>
      {%- endfor -%}
    </ul>
  </div>

  <div class="sr-only focus-within:not-sr-only focus-within:absolute focus-within:top-2 focus-within:left-2 focus-within:z-20 flex gap-2" data-glide-el="controls">
    <button class="button button-secondary button-sm" data-glide-dir="<" aria-label="{{ 'accessibility.previous_slide' | t }}">
      {{ 'accessibility.previous_slide' | t }}
    </button>
    <button class="button button-secondary button-sm" data-glide-dir=">" aria-label="{{ 'accessibility.next_slide' | t }}">
      {{ 'accessibility.next_slide' | t }}
    </button>
  </div>

  <p class="sr-only" data-glide-status aria-live="polite" aria-atomic="true" data-of-text="{{ 'accessibility.of' | t }}"></p>

  <div class="glide__bullets flex absolute bottom-0 left-0 md:relative md:gap-1 lg:flex-col lg:shrink-0 lg:h-[596px] xl:h-[760px] 2xl:h-[954px] lg:overflow-y-auto" data-glide-el="controls[nav]" aria-hidden="true">
    {%- for media in slider_images limit: gallery_limit -%}
      <button class="relative p-2 glide__bullet md:px-0 lg:py-0" data-glide-dir="={{ forloop.index0 }}" tabindex="-1">
        <span class="sr-only">Go to slide {{ forloop.index }}</span>

        {%- liquid
          assign thumb_master = media | image_url
          # safe thumb dimensions
          if media.width and media.width > 0
            assign thumb_w = media.width
          else
            assign thumb_w = 192
          endif

          if media.aspect_ratio and media.aspect_ratio > 0
            assign thumbaspect = media.aspect_ratio
          else
            assign thumbaspect = 1
          endif

          assign thumb_h = thumb_w | divided_by: thumbaspect | round
        -%}

        {% comment %}theme-check-disable RemoteAsset {% endcomment %}
        <img
          srcset="
            {% render 'imgix', src: thumb_master, w: 192 %} 192w,
            {% render 'imgix', src: thumb_master, w: 256 %} 256w
          "
          src="{% render 'imgix', src: thumb_master, w: 256 %}"
          loading="lazy"
          alt="{{ media.alt | escape }}"
          width="{{ thumb_w }}"
          height="{{ thumb_h }}"
          class="hidden object-cover w-24 rounded-md md:block lg:h-32"
        >
        {% comment %}theme-check-enable RemoteAsset {% endcomment %}
      </button>
    {%- endfor -%}
  </div>
</glide-slider>
