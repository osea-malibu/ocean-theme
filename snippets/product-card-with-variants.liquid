{% comment %}
  Product card with variant picker support
  Parameters:
  - card_product: Product object
  - section_id: Section ID for unique identifiers
  - variant_picker_type: 'button', 'dropdown', or 'none' (optional)
  - variant_picker_classes: CSS classes for variant picker (optional)
  - show_secondary_image_on_hover: Boolean for hover image (optional)
  - card_class: CSS classes for card container (optional)
  - image_class: CSS classes for image container (optional)
  - name_class: CSS classes for product name (optional)
  - description_class: CSS classes for description (optional)
  - badge_class: CSS classes for badge (optional)
  - hide_badge: Boolean to hide badge (optional)
  - remove_linking: Boolean to remove product links (optional)
  - remove_lazy_loading: Boolean to remove lazy loading (optional)
  - default_to_mini: Boolean to default to travel size (optional)
  - default_to_jumbo: Boolean to default to jumbo size (optional)
{% endcomment %}

<div class="{% if card_class == blank %}flex flex-col relative grow h-full{% else %}{{ card_class }}{% endif %}">
  <div class="product-info w-full order-1 grow flex flex-col">
    <div>
      {% unless remove_linking %}<a href="{{ card_product.url | default: '#' }}">{% endunless %}
        <h3 class="text-sm 2xs:text-base font-bold 2xs:font-medium !leading-[1.1] hover:underline mb-1{% if name_class != blank %} {{ name_class }}{% endif %}">
          {{- card_product.title | replace: '™', '<sup class="-top-0.5 -mr-0.5 -left-px">™</sup>' | replace: '®', '<sup class="-top-1 -mr-px">®</sup>' -}}
        </h3>
      {% unless remove_linking %}</a>{% endunless %}
    </div>

    <p class="text-sm !leading-[1.1]{% if description_class != blank %} {{ description_class }}{% endif %}">
      {{- card_product.metafields.custom_fields.short_description | escape -}}
    </p>
    
    {%- liquid
      assign product_collections_handles = card_product.collections | map: 'handle'
      if product_collections_handles contains 'exclude-from-site'
        assign excluded_from_site = true
      else
        assign excluded_from_site = false
      endif
    -%}
    
    {%- if excluded_from_site == false and card_product.handle != 'studio-gift-card' -%}
      {%- liquid
        if default_to_mini
          assign mini_index = card_product.variants.size | minus: 1
          if card_product.options.size > 1 or card_product.options contains 'Amount:'
            assign travel_sizes = '1.7 oz, 1 oz, 0.6 oz, 0.22 oz, Scented / 1 oz, $25' | split: ', '
            for variant in card_product.variants
              assign normalized_variant_title = variant.title | replace: 'fl ', ''
              if travel_sizes contains normalized_variant_title
                assign mini_index = forloop.index0
              endif
            endfor
          endif
        endif
      -%}
      
      <div class="mt-auto overflow-hidden px-1 pb-1 -mb-1 -mx-1">
        {%- liquid
          assign product_form_id = 'product-form-' | append: card_product.id | append: '-' | append: section_id
        -%}
        
        {%- if card_product.variants.size > 1 and variant_picker_type != 'none' -%}
          {%- assign dropdown_product_handles = 'gift-card' | split: ', ' -%}
          {%- if variant_picker_type == 'dropdown' or dropdown_product_handles contains card_product.handle -%}
            <variant-selects
              class="no-js-hidden block mt-1"
              data-section="{{ card_product.id }}-{{ section_id }}"
              data-url="{{ card_product.url }}"
              data-update-url="false"
            >
              {%- for option in card_product.options_with_values -%}
                <div class="relative block">
                  <label class="absolute top-0 sm:top-px left-3 z-10 text-xs font-medium block leading-5" for="Option-{{ card_product.id }}-{{ forloop.index0 }}-{{ section_id }}">
                    {{- option.name -}}
                  </label>
                  <select id="Option-{{ card_product.id }}-{{ forloop.index0 }}-{{ section_id }}"
                    class="block input input-xs rounded-full w-full py-px sm:py-0.5 {% if option.name == 'Size' %}pl-10{% else %}pl-16{% endif %}{% if variant_picker_classes != blank %} {{ variant_picker_classes }}{% endif %}"
                    name="options[{{ option.name | escape }}]"
                    form="{{ product_form_id }}"
                  >
                    {%- for value in option.values -%}
                      <option
                        value="{{ value | escape }}"
                        {% if default_to_mini and forloop.index0 == mini_index %}
                          selected="selected"
                        {% elsif default_to_jumbo and forloop.index0 == 0 %}
                          selected="selected"
                        {% elsif default_to_mini != true and default_to_jumbo != true and option.selected_value == value %}
                          selected="selected"
                        {% endif %}
                      >
                        {{ value }}
                      </option>
                    {%- endfor -%}
                  </select>
                </div>
              {%- endfor -%}

              <script type="application/json" class="variant-data">
                {{ card_product.variants | json }}
              </script>
            </variant-selects>
          {%- else -%}
            <variant-radios
              class="no-js-hidden block mt-1.5"
              data-section="{{ card_product.id }}-{{ section_id }}"
              data-url="{{ card_product.url }}"
              data-update-url="false"
            >
              {%- for option in card_product.options_with_values -%}
                <fieldset class="js flex{% if option.name == 'Scent' %} sr-only{% endif %}">
                  <legend class="sr-only">{{ option.name }}</legend>
                  {%- for value in option.values -%}
                    <div>
                      <input type="radio"
                        id="{{ card_product.id }}-{{ option.position }}-{{ forloop.index0 }}-{{ section_id }}"
                        class="peer hidden"
                        name="{{ option.name }}"
                        value="{{ value | escape }}"
                        form="{{ product_form_id }}"
                        {% if option.name == 'Scent' and value == 'Scented' %}
                          checked
                        {% elsif option.name == 'Size' and default_to_mini and forloop.last %}
                          checked
                        {% elsif option.name == 'Size' and default_to_jumbo and forloop.first %}
                          checked
                        {% elsif default_to_mini != true and default_to_jumbo != true and option.selected_value == value %}
                          checked
                        {% endif %}
                      >
                      <label
                        class="button button-xs block button-secondary rounded-full lowercase tracking-wide peer-checked:bg-wave-200 py-px sm:py-0.5 mr-1 xs:mr-2{% if option.values.size > 2 %} px-1.5 2xs:px-2 xs:px-3{% else%} px-2.5 xs:px-3{% endif %}{% if variant_picker_classes != blank %} {{ variant_picker_classes }}{% endif %}"
                        for="{{ card_product.id }}-{{ option.position }}-{{ forloop.index0 }}-{{ section_id }}"
                        tabindex="0"
                      >
                        {{ value }}
                      </label>
                    </div>
                  {%- endfor -%}
                </fieldset>
              {%- endfor -%}

              <script type="application/json" class="variant-data">
                {{ card_product.variants | json }}
              </script>
            </variant-radios>
          {%- endif -%}
        {%- endif -%}
        
        <!-- Add-to-cart button placeholder - will be replaced by buy button snippets when merged -->
        <div class="mt-2">
          <button class="button button-tertiary w-full" disabled>
            Add to Cart
          </button>
        </div>
      </div>
    {%- endif -%}
  </div>

  <div class="relative block overflow-hidden no-underline rounded mb-2" tabindex="-1">
    {%- if card_product.featured_media -%}
      {%- if remove_linking -%}
        <div class="group block bg-wave-100{% if image_class != blank %} {{ image_class }}{% endif %}" tabindex="-1">
      {%- else -%}
        <a
          aria-label="{{ card_product.title | escape }}"
          href="{{ card_product.url | default: '#' }}"
          class="group block bg-wave-100{% if image_class != blank %} {{ image_class }}{% endif %}"
          tabindex="-1"
        >
      {%- endif -%}
        {%- liquid
          if default_to_mini and card_product.variants.size > 1 and card_product.title != 'Digital Gift Card'
            assign default_image = card_product.variants[mini_index].featured_media
          elsif card_product.selected_or_first_available_variant.featured_media != nil
            assign default_image = card_product.selected_or_first_available_variant.featured_media
          else
            assign default_image = card_product.featured_media
          endif

          assign default_image_src = default_image | image_url: width: 328
          assign default_image_src_2x = default_image | image_url: width: 656
          assign hover_image_src = card_product.media[1] | image_url: width: 328
          assign hover_image_src_2x = card_product.media[1] | image_url: width: 656
        -%}
        {% comment %} theme-check-disable RemoteAsset {% endcomment %}
        <img
          srcset="{% render 'imgix', src: default_image_src %} 1x, {% render 'imgix', src: default_image_src_2x %} 2x"
          src="{% render 'imgix', src: default_image_src %}"
          alt="{% if remove_linking %}{{ default_image.alt | escape }}{% endif %}"
          width="{{ default_image.width }}"
          height="{{ default_image.height }}"
          id="ProductCard-DefaultImage-{{ card_product.id }}-{{ section_id }}"
          {% unless remove_lazy_loading %}loading="lazy"{% endunless %}
          class="object-cover"
        >
        {%- if card_product.media[1] != nil and show_secondary_image_on_hover -%}
          <img
            srcset="{% render 'imgix', src: hover_image_src %} 1x, {% render 'imgix', src: hover_image_src_2x %} 2x"
            src="{% render 'imgix', src: hover_image_src %}"
            alt="{{ card_product.media[1].alt | escape }}"
            loading="lazy"
            class="absolute min-h-full inset-x-0 top-1/2 -translate-y-1/2 bg-cover bg-center bg-wave-100 opacity-0 group-hover:opacity-100 motion-safe:transition-opacity duration-300 object-cover"
            width="{{ card_product.media[1].width }}"
            height="{{ card_product.media[1].height }}"
          >
        {%- endif -%}
        {% comment %} theme-check-enable RemoteAsset {% endcomment %}
        {% if remove_linking %}</div>{% else %}</a>{% endif %}
    {%- else -%}
      <h2 class="h3">
        <a href="{{ card_product.url | default: '#' }}">
          {{ card_product.title }}
        </a>
      </h2>
    {%- endif -%}

    {%- if hide_badge != true -%}
      {% render 'product-badge', product: card_product, classes: badge_class %}
    {%- endif -%}
  </div>
</div> 